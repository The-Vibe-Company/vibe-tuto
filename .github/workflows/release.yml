name: Build Release Artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number without v prefix (e.g. 0.1.2)'
        required: true
        type: string
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
      version:
        required: true
        type: string
      upload_url:
        required: true
        type: string

jobs:
  deploy-web:
    name: Deploy Web to Vercel
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name || github.ref }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Deploy to Vercel
        run: npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  build-extension:
    name: Build Chrome Extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name || github.ref }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Package Extension
        working-directory: apps/extension
        run: pnpm package
        env:
          API_URL: https://captuto.com

      - name: Upload Extension to Release
        if: ${{ inputs.upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ inputs.upload_url }}
          asset_path: apps/extension/captuto-extension-v${{ inputs.version }}.zip
          asset_name: captuto-extension-v${{ inputs.version }}.zip
          asset_content_type: application/zip

  build-desktop:
    name: Build macOS Desktop App
    runs-on: macos-15
    env:
      HAS_MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE != '' }}
      HAS_NOTARIZATION: ${{ secrets.APPLE_ID != '' && secrets.APPLE_APP_SPECIFIC_PASSWORD != '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name || github.ref }}

      - name: Install tools
        run: brew install xcodegen create-dmg

      - name: Import Code Signing Certificate
        if: ${{ env.HAS_MACOS_CERTIFICATE == 'true' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$MACOS_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$MACOS_CERTIFICATE_PWD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Build Release DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          SIGN_FLAG=""
          NOTARIZE_FLAG=""
          if [ "$HAS_MACOS_CERTIFICATE" = "true" ]; then
            SIGN_FLAG="--sign"
          fi
          if [ "$HAS_NOTARIZATION" = "true" ] && [ "$HAS_MACOS_CERTIFICATE" = "true" ]; then
            NOTARIZE_FLAG="--notarize"
          fi
          ./scripts/desktop-release-build.sh \
            --version "${{ inputs.version }}" $SIGN_FLAG $NOTARIZE_FLAG

      - name: Upload DMG to Release
        if: ${{ inputs.upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ inputs.upload_url }}
          asset_path: apps/desktop/VibeTuto/.build/release/CapTuto-v${{ inputs.version }}.dmg
          asset_name: CapTuto-v${{ inputs.version }}.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Cleanup Keychain
        if: always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
